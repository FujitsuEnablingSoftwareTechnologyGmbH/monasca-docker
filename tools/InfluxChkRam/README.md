# Introduction
This document describes script InfluxChkRam.sh.

**Background**:  
In certain situations, memory consumption of influxdb is suddenly growing.
At some point of time, normal CMM operation isn’t possible any longer.

As a temporary work-around, we provide a script that will basically stop and restart certain services when memory consumption of influxdb becomes too high.

Besides, a description is provided how to create a cron-job for the execution of the script.
# Script InfluxChkRam
## Description
The script checks RAM usage of influxdb service (running as docker container).  
If "RAM usage" > maxRam% of avail RAM:  
Stop and restart influxdb as well as related services:  
•	Cadvisor  
•	Monasca-agent-collector  
•	Monasca-persister  
•	Influxdb  
maxRam has to be specified as a parameter, pls. refer to chapter Execution.
## Execution
We recommend to copy the script to installation path of CMM.  
I.e., in the directory where docker-compose.yml, docker-compose-log.yml and .env are located.  
The script requires 2 parameters:  
•	directory, where docker-compose.yml and docker-compose-log.yml are located.  
&nbsp; This needs to be an absolute path, starting with “/”.  
•	max. value of RAM to be used:  
&nbsp; This parameter specifies max. percentage of usage of available RAM.  
&nbsp; It must be an integer value between 0 and 100.If you want to test the script directly:  
• cp InfluxChkRam.sh *"CMM installation directory"*  
• sudo chmod +x InfluxChkRam.sh  
• cd *"CMM installation directory"*  
• ./InfluxChkRam.sh *"CMM installation directory"*  
• Output will be written to stdout/stderr  
If you want to execute the script from crontab, pls refer to chapter Crontab.  
## Output
The script writes to stdout/stderr. Thus, output can be redirected to a log file.
Pls. refer to chapter Crontab for details.
# Crontab
A new crontab entry can be generated by calling “crontab –e”. Then, the job can be edited.  
For details about crontab, pls. refer to standard documentation.  
A good introduction to crontab: https://www.ostechnix.com/a-beginners-guide-to-cron-jobs/  
Pls. add the following lines to crontab:  
• SHELL=/bin/bash  
• DOCKERPATH=*"path where InflChkRam.sh has been installed"*  
• PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/bin:$DOCKERPATH  
• 1 * * * *  $DOCKERPATH/InfluxChkRam.sh *"path where docker-compose files and .env are located"* *"max. usage (percentage) of available RAM"* >> *"path to log-file"* 2>&1  
&nbsp; A concrete example for the last line:  
&nbsp; 1 * * * * $DOCKERPATH/InfluxChkRam.sh /opt/monasca-docker 25 >> /tmp/log.cron 2>&1  

**Explanation**:  
•	SHELL: The shell that will be used for execution.  
•	PATH: Specifies the path where executables are searched. Pls. make sure that “docker” and “docker-compose” can be found in the paths given.  
•	Last line: Specifies the command that shall be executed in regular time intervals.  
&nbsp; The first 5 digits specify date and time of execution.  
&nbsp; The example above basically specifies that the executable shall be called every hour, at minute “1”. E.g: at 9:01, 10:01, …  
&nbsp; After last star, the command itself is specified.  
•	“>> /tmp/log.con 2 >&1” means:  
&nbsp; stdout will be appended to file “/tmp/log.cron”. stderr will be redirected to stdout.  
