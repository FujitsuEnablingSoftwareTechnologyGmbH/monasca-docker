# Script purge-zookeeper-txnlogs.sh v1.0.3

## Introduction

This document describes the use of script `purge-zookeeper-txnlogs.sh v1.0.3`

**Background**:

It's critical to set up a cron job to compact Zookeeper's data (snapshots) and transaction logs (txnlogs).

The Zookeeper daemon does not do this on its own, and if it isn't set up as a cron job,
Zookeeper will quickly run out of disk space.

See [1] for more details.

[1] http://storm.apache.org/releases/current/Setting-up-a-Storm-cluster.html

## Description

The script cleans the old txnlogs and snapshots generated by ZooKeeper inside the ZooKeeper and Thresh containers.

By default the script leaves the 10 newest files among snapshots/txnlogs from ZooKeeper and Thresh container.

## Excecution

The script should be executed by the **root** user and the attributes should be changed to `+x`
```
# chmod +x purge-zookeeper-txnlogs.sh
```

Execution with old ZooKeeper's files
```
# ./purge-zookeeper-txnlogs.sh
2020-06-07T13:22:31+0200 INFO : v1.0.3 ==========================================================================================
2020-06-07T13:22:31+0200 INFO : =                                  Purge-ZooKeeper-TxnLogs                                      =
2020-06-07T13:22:31+0200 INFO : =================================================================================================
2020-06-07T13:22:31+0200 INFO : 
2020-06-07T13:22:31+0200 INFO : Cleaning ZooKeeper container...
2020-06-07T13:22:31+0200 INFO :   Searching for old txnlogs/snapshots at /data/version-2
2020-06-07T13:22:32+0200 INFO :     Removing /data/version-2/snapshot.126ec6
2020-06-07T13:22:32+0200 INFO :     Removing /data/version-2/snapshot.11916c
2020-06-07T13:22:32+0200 INFO :     Removing /data/version-2/snapshot.101d58
2020-06-07T13:22:32+0200 INFO :     Removing /data/version-2/snapshot.f1e23
2020-06-07T13:22:32+0200 INFO :     Removing /data/version-2/snapshot.e4f00
2020-06-07T13:22:32+0200 INFO :   Searching for old txnlogs/snapshots at /datalog/version-2
2020-06-07T13:22:32+0200 INFO :     Removing /datalog/version-2/log.126ec8
2020-06-07T13:22:32+0200 INFO :     Removing /datalog/version-2/log.11916e
2020-06-07T13:22:33+0200 INFO :     Removing /datalog/version-2/log.101d5a
2020-06-07T13:22:33+0200 INFO :     Removing /datalog/version-2/log.f1e25
2020-06-07T13:22:33+0200 INFO :     Removing /datalog/version-2/log.e4f02
2020-06-07T13:22:33+0200 INFO : 
2020-06-07T13:22:33+0200 INFO : Cleaning Thresh container...
2020-06-07T13:22:33+0200 INFO :   Found current txnlogs/snapshots directory /tmp/a935e378-4383-4003-97ae-6137e14b5572/version-2
2020-06-07T13:22:33+0200 INFO :   Removing unused txnlogs/snapshots directory /tmp/9399c45a-8a71-48f7-9fd2-1b5cf5df7a5e/version-2
2020-06-07T13:22:33+0200 INFO :   Removing unused txnlogs/snapshots directory /tmp/a78fe6e8-5e9b-4560-950d-80e9bb15665f/version-2
2020-06-07T13:22:33+0200 INFO :   Searching for old txnlogs/snapshots at /tmp/a935e378-4383-4003-97ae-6137e14b5572/version-2
2020-06-07T13:22:33+0200 INFO :     Removing /tmp/a935e378-4383-4003-97ae-6137e14b5572/version-2/snapshot.21e755
2020-06-07T13:22:33+0200 INFO :     Removing /tmp/a935e378-4383-4003-97ae-6137e14b5572/version-2/log.200a79
2020-06-07T13:22:33+0200 INFO :     Removing /tmp/a935e378-4383-4003-97ae-6137e14b5572/version-2/snapshot.20fe28
2020-06-07T13:22:33+0200 INFO :     Removing /tmp/a935e378-4383-4003-97ae-6137e14b5572/version-2/log.1edb61
2020-06-07T13:22:34+0200 INFO :     Removing /tmp/a935e378-4383-4003-97ae-6137e14b5572/version-2/snapshot.200a77
2020-06-07T13:22:34+0200 INFO :     Removing /tmp/a935e378-4383-4003-97ae-6137e14b5572/version-2/log.1d78f1
2020-06-07T13:22:34+0200 INFO :     Removing /tmp/a935e378-4383-4003-97ae-6137e14b5572/version-2/snapshot.1edb5f
2020-06-07T13:22:34+0200 INFO :     Removing /tmp/a935e378-4383-4003-97ae-6137e14b5572/version-2/log.1c53db
```

Execution without old ZooKeeper's files
```
2020-06-07T13:52:07+02:00 INFO : v1.0.3 ==========================================================================================
2020-06-07T13:52:07+02:00 INFO : =                                  Purge-ZooKeeper-TxnLogs                                      =
2020-06-07T13:52:07+02:00 INFO : =================================================================================================
2020-06-07T13:52:07+02:00 INFO :
2020-06-07T13:52:07+02:00 INFO : Cleaning ZooKeeper container...
2020-06-07T13:52:07+02:00 INFO :   Searching for old txnlogs/snapshots at /data/version-2
2020-06-07T13:52:08+02:00 INFO :     No old txnlogs/snapshots were found
2020-06-07T13:52:08+02:00 INFO :   Searching for old txnlogs/snapshots at /datalog/version-2
2020-06-07T13:52:09+02:00 INFO :     No old txnlogs/snapshots were found
2020-06-07T13:52:09+02:00 INFO :
2020-06-07T13:52:09+02:00 INFO : Cleaning Thresh container...
2020-06-07T13:52:09+02:00 INFO :   Found current txnlogs/snapshots directory /tmp/806f0746-0b61-4cd5-883b-9e8fe7f3c4f9/version-2
2020-06-07T13:52:09+02:00 INFO :   Searching for old txnlogs/snapshots at /tmp/806f0746-0b61-4cd5-883b-9e8fe7f3c4f9/version-2
2020-06-07T13:52:09+02:00 INFO :     No old txnlogs/snapshots were found
```

## Cron Job

In order tu set `purge-zookeeper-txnlogs.sh` as a cron job follow these instructions as the **root** user:

In this example the script `purge-zookeeper-txnlogs.sh` will be executed on Sundays at 2:00 am.
The output will be redirect to the syslog. `/var/log/messages` in case of RHEL.

1. Save the script `purge-zookeeper-txnlogs.sh` in `/opt/cmm-server/`
2. Change the attributes to `+x`
```
# chmod 500 purge-zookeeper-txnlogs.sh
```

3. Add the record in crontab:

```
# crontab -e
0 2 * * 0 /opt/cmm-server/purge-zookeeper-txnlogs.sh 2>&1 | logger
```
